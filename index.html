<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Zoom Infini Test</title>
    <script src="https://openseadragon.github.io/openseadragon/openseadragon.min.js"></script>
    <style>
        html, body { margin:0; padding:0; height:100%; }
        #viewer { width: 100%; height: 100vh; background-color: black; }
    </style>
</head>
<body>
<div id="viewer"></div>

<script>
var viewer = OpenSeadragon({
    id: "viewer",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: "sortie.dzi",
    showNavigator: false
});

let firstPoint = null;

viewer.addHandler('canvas-click', function(event){
    if(!event.position) return;

    let viewportPoint = viewer.viewport.pointFromPixel(event.position);
    let img = viewer.world.getItemAt(0);
    let imagePoint = viewer.viewport.viewportToImageCoordinates(viewportPoint);
    let imgSize = img.getContentSize();

    let normX = imagePoint.x / imgSize.x;
    let normY = imagePoint.y / imgSize.y;

    if(!firstPoint){
        firstPoint = { x: normX, y: normY };
        console.log("Coin haut gauche enregistré :", firstPoint);
    } else {
        let secondPoint = { x: normX, y: normY };
        let x = Math.min(firstPoint.x, secondPoint.x);
        let y = Math.min(firstPoint.y, secondPoint.y);
        let width = Math.abs(secondPoint.x - firstPoint.x);
        let height = Math.abs(secondPoint.y - firstPoint.y);

        console.log("==== DETAIL COORDS PRÊT À COLLER ====");
        console.log(`x: ${x}`);
        console.log(`y: ${y}`);
        console.log(`width: ${width}`);
        console.log(`height: ${height}`);

        // Création d’un canvas temporaire pour la capture
        let canvas = document.createElement("canvas");
        canvas.width = width * imgSize.x;
        canvas.height = height * imgSize.y;
        let ctx = canvas.getContext("2d");

        let imgElement = img.source['tileUrl'] ? new Image() : null;
        if(imgElement){
            imgElement.onload = function(){
                ctx.drawImage(
                    imgElement,
                    x * imgSize.x, y * imgSize.y,
                    width * imgSize.x, height * imgSize.y,
                    0, 0,
                    width * imgSize.x, height * imgSize.y
                );
                // Création du lien de téléchargement
                let link = document.createElement('a');
                link.download = "zone_selection.png";
                link.href = canvas.toDataURL("image/png");
                link.click();
            };
            imgElement.crossOrigin = "Anonymous";
            imgElement.src = img.source['tileUrl'];
        } else {
            alert("Impossible de capturer : image source non disponible directement.");
        }

        firstPoint = null; // reset
    }
});
</script>
</body>
</html>



