<script>
var viewer = OpenSeadragon({
    id: "viewer",
    prefixUrl: "https://openseadragon.github.io/openseadragon/images/",
    tileSources: "sortie.dzi",
    showNavigator: false
});

// ============================
// OUTIL RECTANGLE PRO
// ============================

let startPoint = null;

let overlay = document.createElement("div");
overlay.style.position = "absolute";
overlay.style.border = "2px solid red";
overlay.style.pointerEvents = "none";
overlay.style.display = "none";

viewer.canvas.appendChild(overlay);

// Début sélection
viewer.addHandler('canvas-press', function(event){
    startPoint = viewer.viewport.pointFromPixel(event.position);
    overlay.style.display = "block";
});

// Dessin rectangle
viewer.addHandler('canvas-drag', function(event){

    if(!startPoint) return;

    let current = viewer.viewport.pointFromPixel(event.position);

    let rect = new OpenSeadragon.Rect(
        Math.min(startPoint.x, current.x),
        Math.min(startPoint.y, current.y),
        Math.abs(startPoint.x - current.x),
        Math.abs(startPoint.y - current.y)
    );

    let pixelRect = viewer.viewport.pixelFromPoint(rect.getTopLeft(), true);
    let pixelSize = viewer.viewport.deltaPixelsFromPoints(
        new OpenSeadragon.Point(rect.width, rect.height), true
    );

    overlay.style.left = pixelRect.x + "px";
    overlay.style.top = pixelRect.y + "px";
    overlay.style.width = pixelSize.x + "px";
    overlay.style.height = pixelSize.y + "px";
});

// Fin sélection → calcul
viewer.addHandler('canvas-release', function(event){

    if(!startPoint) return;

    let endPoint = viewer.viewport.pointFromPixel(event.position);

    let rect = new OpenSeadragon.Rect(
        Math.min(startPoint.x, endPoint.x),
        Math.min(startPoint.y, endPoint.y),
        Math.abs(startPoint.x - endPoint.x),
        Math.abs(startPoint.y - endPoint.y)
    );

    let img = viewer.world.getItemAt(0);
    let size = img.getContentSize();

    let topLeft = viewer.viewport.viewportToImageCoordinates(rect.getTopLeft());
    let bottomRight = viewer.viewport.viewportToImageCoordinates(rect.getBottomRight());

    let x = topLeft.x / size.x;
    let y = topLeft.y / size.y;
    let w = (bottomRight.x - topLeft.x) / size.x;
    let h = (bottomRight.y - topLeft.y) / size.y;

    console.log("==== DETAIL COORDS ====");
    console.log(`x: ${x}`);
    console.log(`y: ${y}`);
    console.log(`width: ${w}`);
    console.log(`height: ${h}`);

    overlay.style.display = "none";
    startPoint = null;
});
</script>

